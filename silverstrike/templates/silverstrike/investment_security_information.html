{% extends 'silverstrike/base.html' %}
{% load i18n %}
{% load static %}

{% block content_header %}
<h1>{{ securityDetails.name }}</h1>
<ol class="breadcrumb">
  <li><a href="/">{% trans 'Home' %}</a></li>
  <li class="active">{% trans 'Charts' %}</li>
</ol>
{% endblock %}
{% block content %}
<div id="loader-body">
    <div class="loader loader-content" id="loader"></div>
    <div class="loader-text loader-content">
        Updating prices ...
    </div>
</div>
<div id="main">
<div class="row">
<div class="col-md-6">
  <div class="box">
    <div class="box-header">
      <h3 class="box-title">Price</h3>
    </div>
    <div class="box-body">
      <canvas id="myChart"></canvas>
    </div>
  </div>
</div>
<div class="col-md-6">
  <div class="box">
    <div class="box-header">
      <h3 class="box-title">Stats</h3>
    </div>
    <div class="box-content">
        <table class="table">
          <tr>
          <th>{% trans 'Current Assets' %}</th><td>{{ currentAssets }}</td>
        </tr>
        <tr>
          <th>{% trans 'Current Price' %}</th><td>{{ securityPrice.price }} €</td>
        </tr>
        <tr>
          <th>{% trans 'Current Total' %}</th><td>{{ totalPrice }} €</td>
        </tr>
        <tr>
          <th>{% trans 'YTD Return' %}</th><td id="ytd_return" >0</td>
        </tr>
        <tr>
          <th>{% trans 'Total Return' %}</th><td id="total_return">0</td>
        </tr>
        </table>
      </div>
    <div class="box-footer">
      <form method="post" onsubmit="blurToggle()" on>
        {% csrf_token %}
        <button type="submit" name="update_price" class="btn btn-default">{% trans 'Update Prices' %}</button>
      </form>
              <small>Last update: {{ securityPrice.date }}</small>

    </div>
  </div>
</div>
<div class="col-md-6">
  <div class="box">
    <div class="box-header">
      <h3 class="box-title">Last Operations</h3>
    </div>
    <div class="box-body">
      <table class="table table-striped">
          <tr>
            <th>{% trans 'Ticker' %}</th>
            <th>{% trans 'Name' %}</th>
            <th class="hidden-xs">{% trans 'ISIN' %}</th>
              <th>{% trans 'TER' %}</th>
            <th>{% trans 'Exchange' %}</th>
            <th>{% trans 'Currency' %}</th>
          </tr>
        <tr>
          <td>{{ securityDetails.ticker }}</td>
          <td>{{ securityDetails.name }}</td>
          <td>{{ securityDetails.isin }}</td>
          <td>{{ securityDetails.ter }}</td>
          <td>{{ securityDetails.exchange }}</td>
          <td>{{ securityDetails.currency }}</td>
        </tr>
       </table>
    </div>
  </div>
</div>
<div class="col-md-6">
  <div class="box">
    <div class="box-header">
      <h3 class="box-title">Details</h3>
    </div>
    <div class="box-body">
      <table class="table table-striped">
          <tr>
            <th>{% trans 'Ticker' %}</th>
            <th>{% trans 'Name' %}</th>
            <th class="hidden-xs">{% trans 'ISIN' %}</th>
              <th>{% trans 'TER' %}</th>
            <th>{% trans 'Exchange' %}</th>
            <th>{% trans 'Currency' %}</th>
          </tr>
        <tr>
          <td>{{ securityDetails.ticker }}</td>
          <td>{{ securityDetails.name }}</td>
          <td>{{ securityDetails.isin }}</td>
          <td>{{ securityDetails.ter }}</td>
          <td>{{ securityDetails.exchange }}</td>
          <td>{{ securityDetails.currency }}</td>
        </tr>
       </table>
    </div>
    <div class="box-footer">
      <a href="{% url 'investment_security_update' securityDetails.isin %}" class="btn btn-primary">{% trans 'Edit' %}</a>

    </div>
  </div>
</div>
<div class="col-md-12">
  <div class="box">
    <div class="box-header">
      <h3 class="box-title">Distribution</h3>

    </div>
    <div class="box-body">

      <table class="table table-striped">

          <tr>
            <th>{% trans '' %}</th>

            {% for element in distributionLabels %}
              <th>{% trans element %}</th>

            {% endfor %}
          </tr>
        <tr>
          <td>{% trans 'Percentage' %}</td>
          {% for element in securityDistribution %}
            <td>{{ element.allocation }} %</td>
          {% endfor %}
        </tr>
        <tr>
          <td>{% trans 'Amount' %}</td>
          {% for element in securityDistributionPrice %}
            <td>{{ element |floatformat:2 }} €</td>
          {% endfor %}
        </tr>
       </table>
    </div>
    <div class="box-footer">
        <a href="{% url 'investment_security_distribution' securityDetails.isin %}" class="btn btn-primary">{% trans 'Edit' %}</a>
    </div>
  </div>

</div>
</div>
</div>

<style>
.loader {
  border: 10px solid #f3f3f3;
  border-radius: 50%;
  border-top: 10px solid #3498db;
  width: 60px;
  height: 60px;
  -webkit-animation: spin 1.5s linear infinite; /* Safari */
  animation: spin 1.5s linear infinite;

}
.loader-content {
  position:absolute;
  top: 0; bottom: 0; left: 0; right: 0;
  margin: auto;
}

.loader-text {
    top: 150px;
    width: 60px;
    height: 60px;
    text-align: center;
    font-weight: bold;
}

/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.blurredElement {
     /* Any browser which supports CSS3 */
    filter: blur(7px);

    /* Firefox version 34 and earlier */
    filter: url("blur.svg#gaussian_blur");

    /* Webkit in Chrome 52, Safari 9, Opera 39, and earlier */
    -webkit-filter: blur(7px);
}

#loader-body {
  position: fixed; /* Sit on top of the page content */
  display: none; /* Hidden by default */
  width: 100%; /* Full width (cover the whole page) */
  height: 100%; /* Full height (cover the whole page) */
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
  cursor: pointer; /* Add a pointer on hover */
}

</style>
{% endblock %}
{% block scripts %}
<script src="{% static 'vendor/js/Chart.bundle.min.js' %}"></script>
<script type="text/javascript">
  jQuery(document).ready(function($){
    $(document).on( 'frmFormComplete', function( event, form, response ) {
      blurToggle();
    });
  });

  $.getJSON("{% url 'api_security_prices' securityDetails.isin dates.0 dates.1 %}", {}, function(res, status) {
  var ytd_return = document.getElementById("ytd_return");
  ret = ((res.data[res.data.length - 1] - res.data[0]) / res.data[0]).toFixed(4)*100;
  ytd_return.innerText = ret+" %";

  if(ret > 0){
    ytd_return.classList.add("text-green");
  }

  var ctx = document.getElementById("myChart").getContext('2d');
  var myChart = new Chart(ctx, {
      type: 'line',
      options: {
          legend: {
            position: 'none'
          },
          scales: {
              yAxes: [{
                  ticks: {
                      beginAtZero: false
                  }
              }]
          }
      },
      data: {
          labels: res.labels,
          datasets: [{
              label: 'Balance',
              fill: false,
              pointRadius: 2,
              borderColor: '#357ca5',
              backgroundColor: '#357ca5',
              data: res.data
          }]
      }
    });
  });

  function blurToggle(){
    var element = $("#main");
    var loader = $("#loader-body");
    if(element.hasClass("blurredElement")){
        element.removeClass("blurredElement");
        loader.hide();
    } else {
        element.addClass("blurredElement");
        loader.show();
    }
 }
</script>

{% endblock %}